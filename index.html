<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSU Clinic - Digital Health Records</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #ffffff 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #87CEEB 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: white;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.2);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #87CEEB 0%, #5F9EA0 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(135, 206, 235, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-google {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .btn-google:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .nav-menu {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-menu ul {
            list-style: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .nav-menu li {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            background: #f0f8ff;
            color: #4A90E2;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-menu li:hover,
        .nav-menu li.active {
            background: #4A90E2;
            color: white;
            transform: translateY(-2px);
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            background: white;
        }

        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .appointment-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4A90E2;
        }

        .appointment-card h3 {
            color: #4A90E2;
            margin-bottom: 10px;
        }

        .appointment-card p {
            margin: 5px 0;
            color: #666;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .records-table th,
        .records-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .records-table th {
            background: #4A90E2;
            color: white;
            font-weight: 600;
        }

        .records-table tr:hover {
            background: #f0f8ff;
        }

        .user-info {
            background: linear-gradient(135deg, #4A90E2 0%, #87CEEB 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .user-info h2 {
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4A90E2;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #4A90E2;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .readonly {
            background: #f5f5f5 !important;
            cursor: not-allowed;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .nav-menu ul {
                flex-direction: column;
                align-items: center;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .appointments-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>üè• SSU Clinic</h1>
            <p>Digital Health Records Management System</p>
        </div>
    </div>

    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="card">
            <h2 style="text-align: center; color: #4A90E2; margin-bottom: 30px;">Welcome Back!</h2>
            <div id="loginAlert"></div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password">
            </div>
            
            <button class="btn btn-primary" id="loginBtn" style="width: 100%; margin-bottom: 15px;">Sign In</button>
            
            <button class="btn btn-google" id="googleSignInBtn" style="width: 100%; margin-bottom: 15px;">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
            
            <p style="text-align: center; margin-top: 20px;">
                Don't have an account? 
                <a href="#" id="showRegister" style="color: #4A90E2; text-decoration: none; font-weight: 600;">Sign Up Here</a>
            </p>
        </div>

        <!-- Registration Page -->
        <div id="registerPage" class="card hidden">
            <h2 style="text-align: center; color: #4A90E2; margin-bottom: 30px;">Create Your Account</h2>
            <div id="registerAlert"></div>
            
            <div class="two-column">
                <div class="form-group">
                    <label>ID Number *</label>
                    <input type="text" id="registerIdNumber" placeholder="Enter your ID number" required>
                </div>
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="registerFullName" placeholder="Enter your full name" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="registerEmail" placeholder="Enter your email" required>
            </div>
            
            <div class="form-group">
                <label>Contact Number *</label>
                <input type="tel" id="registerContact" placeholder="Enter your contact number" required>
            </div>
            
            <div class="form-group">
                <label>Department *</label>
                <select id="registerDepartment" required>
                    <option value="">Select your department</option>
                    <option value="CAS">College of Arts and Sciences (CAS)</option>
                    <option value="CIT">College of Industrial Technology (CIT)</option>
                    <option value="COED">College of Education (COED)</option>
                    <option value="COENG">College of Engineering (COENG)</option>
                    <option value="CONHS">College of Nursing and Health Sciences (CONHS)</option>
                    <option value="SIIM">Samar Island Institute of Medicine (SIIM)</option>
                    <option value="Mercedes Campus">Mercedes Campus</option>
                    <option value="Paranas Campus">Paranas Campus</option>
                    <option value="Basey Campus">Basey Campus</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="registerPassword" placeholder="Create a password (min. 6 characters)" required>
            </div>
            
            <button class="btn btn-primary" id="registerBtn" style="width: 100%; margin-bottom: 15px;">Create Account</button>
            
            <p style="text-align: center;">
                Already have an account? 
                <a href="#" id="showLogin" style="color: #4A90E2; text-decoration: none; font-weight: 600;">Sign In Here</a>
            </p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- User Info -->
            <div class="user-info">
                <h2 id="userWelcome">Welcome!</h2>
                <p id="userDetails"></p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                    <button class="btn btn-secondary" id="showSettingsBtn" style="margin-left: 10px;">Settings</button>
                </div>
            </div>

            <!-- Navigation Menu -->
            <div class="nav-menu">
                <ul>
                    <li class="nav-item active" data-section="appointments">üìÖ My Appointments</li>
                    <li class="nav-item" data-section="bookAppointment">‚ûï Book Appointment</li>
                    <li class="nav-item" data-section="healthRecords">üìã Health Records</li>
                    <li class="nav-item admin-only hidden" data-section="adminPanel">üë®‚Äç‚öïÔ∏è Admin Panel</li>
                </ul>
            </div>

            <!-- Appointments Section -->
            <div id="appointmentsSection">
                <div class="card">
                    <h3 style="color: #4A90E2; margin-bottom: 20px;">üìÖ My Upcoming Appointments</h3>
                    <div id="appointmentsList" class="appointments-grid"></div>
                </div>
            </div>

            <!-- Book Appointment Section -->
            <div id="bookAppointmentSection" class="hidden">
                <div class="card">
                    <h3 style="color: #4A90E2; margin-bottom: 20px;">‚ûï Book New Appointment</h3>
                    <div id="appointmentAlert"></div>
                    
                    <div class="form-group">
                        <label>Reason for Visit *</label>
                        <textarea id="appointmentReason" placeholder="Describe your symptoms or reason for visit" rows="4" required></textarea>
                    </div>
                    
                    <div class="two-column">
                        <div class="form-group">
                            <label>Preferred Date *</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Preferred Time *</label>
                            <input type="time" id="appointmentTime" required>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="bookAppointmentBtn">Book Appointment</button>
                </div>
            </div>

            <!-- Health Records Section -->
            <div id="healthRecordsSection" class="hidden">
                <div class="card">
                    <h3 style="color: #4A90E2; margin-bottom: 20px;">üìã My Health Records</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" id="exportPdfBtn">üìÑ Export to PDF</button>
                    </div>
                    <div id="healthRecordsList"></div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanelSection" class="hidden">
                <div class="card">
                    <h3 style="color: #4A90E2; margin-bottom: 20px;">üë®‚Äç‚öïÔ∏è Admin Panel</h3>
                    
                    <div class="nav-menu">
                        <ul>
                            <li class="admin-nav-item active" data-section="allAppointments">All Appointments</li>
                            <li class="admin-nav-item" data-section="addRecord">Add Health Record</li>
                        </ul>
                    </div>

                    <!-- All Appointments View -->
                    <div id="allAppointmentsView">
                        <div class="search-bar">
                            <input type="text" id="adminSearchBar" placeholder="Search by ID number, name, or department...">
                        </div>
                        <div id="allAppointmentsList"></div>
                    </div>

                    <!-- Add Health Record View -->
                    <div id="addRecordView" class="hidden">
                        <div id="addRecordAlert"></div>
                        
                        <div class="form-group">
                            <label>Student ID Number *</label>
                            <input type="text" id="recordStudentId" placeholder="Enter student ID number" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Student Full Name *</label>
                            <input type="text" id="recordStudentName" placeholder="Enter student full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Physician's Findings *</label>
                            <textarea id="recordFindings" placeholder="Enter physician's findings and diagnosis" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Attending Physician *</label>
                            <input type="text" id="recordPhysician" placeholder="Enter attending physician's name" required>
                        </div>
                        
                        <button class="btn btn-primary" id="addRecordBtn">Add Health Record</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettings">&times;</span>
                <h3 style="color: #4A90E2; margin-bottom: 20px;">Account Settings</h3>
                <div id="settingsAlert"></div>
                
                <div class="form-group">
                    <label>ID Number</label>
                    <input type="text" id="settingsIdNumber" class="readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="settingsFullName" class="readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label>Registration Date</label>
                    <input type="text" id="settingsRegDate" class="readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="settingsEmail">
                </div>
                
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="tel" id="settingsContact">
                </div>
                
                <div class="form-group">
                    <label>Department</label>
                    <select id="settingsDepartment">
                        <option value="CAS">College of Arts and Sciences (CAS)</option>
                        <option value="CIT">College of Information Technology (CIT)</option>
                        <option value="COED">College of Education (COED)</option>
                        <option value="COENG">College of Engineering (COENG)</option>
                        <option value="CONHS">College of Nursing and Health Sciences (CONHS)</option>
                        <option value="SIIM">School of International and Interdisciplinary Management (SIIM)</option>
                        <option value="Mercedes Campus">Mercedes Campus</option>
                        <option value="Paranas Campus">Paranas Campus</option>
                        <option value="Basey Campus">Basey Campus</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" id="settingsPassword" placeholder="Enter new password">
                </div>
                
                <button class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateEmail, updatePassword } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3DNnP02Hducv1ql9ZAT_xhhRbxHOftaA",
            authDomain: "ssuclinic-46e9b.firebaseapp.com",
            projectId: "ssuclinic-46e9b",
            storageBucket: "ssuclinic-46e9b.firebasestorage.app",
            messagingSenderId: "287543677080",
            appId: "1:287543677080:web:ef7f3894881507b2af00ed",
            measurementId: "G-ZLTVDBGZ27"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Global variables
        let currentUser = null;
        let currentUserData = null;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const registerPage = document.getElementById('registerPage');
        const dashboard = document.getElementById('dashboard');
        const settingsModal = document.getElementById('settingsModal');

        // Utility Functions
        function showAlert(elementId, message, type = 'error') {
            const alertElement = document.getElementById(elementId);
            alertElement.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertElement.innerHTML = '';
            }, 5000);
        }

        function setMinDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = minDate;
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Authentication Functions
        async function registerUser() {
            const idNumber = document.getElementById('registerIdNumber').value.trim();
            const fullName = document.getElementById('registerFullName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const contact = document.getElementById('registerContact').value.trim();
            const department = document.getElementById('registerDepartment').value;
            const password = document.getElementById('registerPassword').value;

            if (!idNumber || !fullName || !email || !contact || !department || !password) {
                showAlert('registerAlert', 'Please fill in all required fields.');
                return;
            }

            if (password.length < 6) {
                showAlert('registerAlert', 'Password must be at least 6 characters long.');
                return;
            }

            try {
                // Check if ID number already exists
                const idQuery = query(collection(db, 'users'), where('idNumber', '==', idNumber));
                const idQuerySnapshot = await getDocs(idQuery);
                
                if (!idQuerySnapshot.empty) {
                    showAlert('registerAlert', 'ID Number already exists. Please use a different ID number.');
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Save user data to Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    idNumber,
                    fullName,
                    email,
                    contact,
                    department,
                    createdAt: serverTimestamp(),
                    isAdmin: false
                });

                showAlert('registerAlert', 'Account created successfully! Please sign in.', 'success');
                
                setTimeout(() => {
                    showLoginPage();
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                showAlert('registerAlert', error.message);
            }
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('loginAlert', 'Please enter both email and password.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                showAlert('loginAlert', 'Invalid email or password. Please try again.');
            }
        }

        async function googleSignIn() {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user exists in our database
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (!userDoc.exists()) {
                    // Redirect to complete registration
                    await signOut(auth);
                    showAlert('loginAlert', 'Please complete your registration first using the Sign Up form.');
                    showRegisterPage();
                    document.getElementById('registerEmail').value = user.email;
                }
            } catch (error) {
                console.error('Google Sign-In error:', error);
                showAlert('loginAlert', 'Failed to sign in with Google. Please try again.');
            }
        }

        async function logoutUser() {
            try {
                await signOut(auth);
                currentUser = null;
                currentUserData = null;
                showLoginPage();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Page Navigation Functions
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            registerPage.classList.add('hidden');
            dashboard.classList.add('hidden');
        }

        function showRegisterPage() {
            registerPage.classList.remove('hidden');
            loginPage.classList.add('hidden');
            dashboard.classList.add('hidden');
        }

        function showDashboard() {
            dashboard.classList.remove('hidden');
            loginPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            loadUserDashboard();
        }

        // Dashboard Functions
        async function loadUserDashboard() {
            if (!currentUser) return;

            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    
                    // Update user info
                    document.getElementById('userWelcome').textContent = `Welcome, ${currentUserData.fullName}!`;
                    document.getElementById('userDetails').textContent = `ID: ${currentUserData.idNumber} | Department: ${currentUserData.department}`;
                    
                    // Show admin menu if user is admin
                    if (currentUserData.isAdmin) {
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                    }

                    // Load appointments
                    loadUserAppointments();
                    loadUserHealthRecords();
                    
                    // Set minimum date for appointments
                    setMinDate();
                }
            } catch (error) {
                console.error('Error loading user dashboard:', error);
            }
        }

        async function loadUserAppointments() {
            const appointmentsList = document.getElementById('appointmentsList');
            appointmentsList.innerHTML = '<div class="loading">Loading appointments...</div>';

            try {
                const appointmentsQuery = query(
                    collection(db, 'appointments'), 
                    where('userId', '==', currentUser.uid),
                    orderBy('appointmentDate', 'desc')
                );
                const querySnapshot = await getDocs(appointmentsQuery);
                
                appointmentsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    appointmentsList.innerHTML = '<p style="text-align: center; color: #666;">No appointments found. Book your first appointment!</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const appointment = doc.data();
                    const appointmentCard = document.createElement('div');
                    appointmentCard.className = 'appointment-card';
                    appointmentCard.innerHTML = `
                        <h3>üìÖ ${formatDate(appointment.appointmentDate.toDate())}</h3>
                        <p><strong>Reason:</strong> ${appointment.reason}</p>
                        <p><strong>Status:</strong> <span style="color: #4A90E2;">Scheduled</span></p>
                        <p><strong>Booked on:</strong> ${formatDate(appointment.createdAt.toDate())}</p>
                    `;
                    appointmentsList.appendChild(appointmentCard);
                });
            } catch (error) {
                console.error('Error loading appointments:', error);
                appointmentsList.innerHTML = '<p style="color: #ff6b6b;">Error loading appointments. Please try again.</p>';
            }
        }

        async function bookAppointment() {
            const reason = document.getElementById('appointmentReason').value.trim();
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;

            if (!reason || !date || !time) {
                showAlert('appointmentAlert', 'Please fill in all fields.');
                return;
            }

            const appointmentDateTime = new Date(`${date}T${time}`);
            
            if (appointmentDateTime <= new Date()) {
                showAlert('appointmentAlert', 'Please select a future date and time.');
                return;
            }

            try {
                await addDoc(collection(db, 'appointments'), {
                    userId: currentUser.uid,
                    studentId: currentUserData.idNumber,
                    studentName: currentUserData.fullName,
                    department: currentUserData.department,
                    reason: reason,
                    appointmentDate: appointmentDateTime,
                    createdAt: new Date(),
                    status: 'scheduled'
                });

                showAlert('appointmentAlert', 'Appointment booked successfully!', 'success');
                
                // Clear form
                document.getElementById('appointmentReason').value = '';
                document.getElementById('appointmentDate').value = '';
                document.getElementById('appointmentTime').value = '';
                
                // Refresh appointments
                loadUserAppointments();

            } catch (error) {
                console.error('Error booking appointment:', error);
                showAlert('appointmentAlert', 'Failed to book appointment. Please try again.');
            }
        }

        async function loadUserHealthRecords() {
            const healthRecordsList = document.getElementById('healthRecordsList');
            healthRecordsList.innerHTML = '<div class="loading">Loading health records...</div>';

            try {
                const recordsQuery = query(
                    collection(db, 'healthRecords'), 
                    where('studentId', '==', currentUserData.idNumber),
                    orderBy('createdAt', 'desc')
                );
                const querySnapshot = await getDocs(recordsQuery);
                
                if (querySnapshot.empty) {
                    healthRecordsList.innerHTML = '<p style="text-align: center; color: #666;">No health records found.</p>';
                    return;
                }

                let recordsHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reason</th>
                                <th>Physician's Findings</th>
                                <th>Attending Physician</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                querySnapshot.forEach((doc) => {
                    const record = doc.data();
                    recordsHTML += `
                        <tr>
                            <td>${formatDate(record.createdAt.toDate())}</td>
                            <td>${record.reason || 'N/A'}</td>
                            <td>${record.findings}</td>
                            <td>${record.physician}</td>
                        </tr>
                    `;
                });

                recordsHTML += '</tbody></table>';
                healthRecordsList.innerHTML = recordsHTML;

            } catch (error) {
                console.error('Error loading health records:', error);
                healthRecordsList.innerHTML = '<p style="color: #ff6b6b;">Error loading health records. Please try again.</p>';
            }
        }

        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFillColor(74, 144, 226);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.text('üè• SAMAR STATE UNIVERSITY CLINIC', 105, 15, { align: 'center' });
                doc.setFontSize(14);
                doc.text('Digital Health Record', 105, 25, { align: 'center' });

                // Patient Info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text(`Patient: ${currentUserData.fullName}`, 20, 55);
                doc.text(`ID Number: ${currentUserData.idNumber}`, 20, 65);
                doc.text(`Department: ${currentUserData.department}`, 20, 75);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 85);

                // Table Header
                let yPos = 105;
                doc.setFillColor(135, 206, 235);
                doc.rect(20, yPos - 10, 170, 20, 'F');
                doc.setFont("helvetica", "bold");
                doc.text('Date', 25, yPos);
                doc.text('Reason', 65, yPos);
                doc.text('Findings', 105, yPos);
                doc.text('Physician', 145, yPos);

                // Get health records
                const recordsQuery = query(
                    collection(db, 'healthRecords'), 
                    where('studentId', '==', currentUserData.idNumber),
                    orderBy('createdAt', 'desc')
                );
                const querySnapshot = await getDocs(recordsQuery);

                yPos += 15;
                doc.setFont("helvetica", "normal");

                querySnapshot.forEach((docSnapshot) => {
                    const record = docSnapshot.data();
                    
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }

                    const date = new Date(record.createdAt.toDate()).toLocaleDateString();
                    const reason = record.reason || 'N/A';
                    const findings = record.findings.substring(0, 30) + (record.findings.length > 30 ? '...' : '');
                    const physician = record.physician.substring(0, 25) + (record.physician.length > 25 ? '...' : '');

                    doc.text(date, 25, yPos);
                    doc.text(reason.substring(0, 20), 65, yPos);
                    doc.text(findings, 105, yPos);
                    doc.text(physician, 145, yPos);
                    
                    yPos += 10;
                });

                if (querySnapshot.empty) {
                    doc.text('No health records found.', 25, yPos);
                }

                // Footer
                doc.setFontSize(10);
                doc.text('This is an official document generated from SSU Clinic Digital Health Records System.', 105, 280, { align: 'center' });

                doc.save(`${currentUserData.fullName}_HealthRecord.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }
        }

        // Admin Functions
        async function loadAllAppointments() {
            const appointmentsList = document.getElementById('allAppointmentsList');
            appointmentsList.innerHTML = '<div class="loading">Loading all appointments...</div>';

            try {
                const appointmentsQuery = query(collection(db, 'appointments'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(appointmentsQuery);
                
                appointmentsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    appointmentsList.innerHTML = '<p style="text-align: center; color: #666;">No appointments found.</p>';
                    return;
                }

                let appointmentsHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Department</th>
                                <th>Reason</th>
                                <th>Appointment Date</th>
                                <th>Booked Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody">
                `;

                querySnapshot.forEach((doc) => {
                    const appointment = doc.data();
                    appointmentsHTML += `
                        <tr class="appointment-row" data-search="${appointment.studentId} ${appointment.studentName} ${appointment.department}">
                            <td>${appointment.studentId}</td>
                            <td>${appointment.studentName}</td>
                            <td>${appointment.department}</td>
                            <td>${appointment.reason}</td>
                            <td>${formatDate(appointment.appointmentDate.toDate())}</td>
                            <td>${formatDate(appointment.createdAt.toDate())}</td>
                            <td><span style="color: #4A90E2;">Scheduled</span></td>
                        </tr>
                    `;
                });

                appointmentsHTML += '</tbody></table>';
                appointmentsList.innerHTML = appointmentsHTML;

            } catch (error) {
                console.error('Error loading appointments:', error);
                appointmentsList.innerHTML = '<p style="color: #ff6b6b;">Error loading appointments. Please try again.</p>';
            }
        }

        async function addHealthRecord() {
            const studentId = document.getElementById('recordStudentId').value.trim();
            const studentName = document.getElementById('recordStudentName').value.trim();
            const findings = document.getElementById('recordFindings').value.trim();
            const physician = document.getElementById('recordPhysician').value.trim();

            if (!studentId || !studentName || !findings || !physician) {
                showAlert('addRecordAlert', 'Please fill in all fields.');
                return;
            }

            try {
                await addDoc(collection(db, 'healthRecords'), {
                    studentId: studentId,
                    studentName: studentName,
                    findings: findings,
                    physician: physician,
                    createdAt: new Date()
                });

                showAlert('addRecordAlert', 'Health record added successfully!', 'success');
                
                // Clear form
                document.getElementById('recordStudentId').value = '';
                document.getElementById('recordStudentName').value = '';
                document.getElementById('recordFindings').value = '';
                document.getElementById('recordPhysician').value = '';

            } catch (error) {
                console.error('Error adding health record:', error);
                showAlert('addRecordAlert', 'Failed to add health record. Please try again.');
            }
        }

        // Settings Functions
        function showSettings() {
            if (!currentUserData) return;
            
            document.getElementById('settingsIdNumber').value = currentUserData.idNumber;
            document.getElementById('settingsFullName').value = currentUserData.fullName;
            document.getElementById('settingsRegDate').value = formatDate(currentUserData.registrationDate.toDate());
            document.getElementById('settingsEmail').value = currentUserData.email;
            document.getElementById('settingsContact').value = currentUserData.contact;
            document.getElementById('settingsDepartment').value = currentUserData.department;
            document.getElementById('settingsPassword').value = '';
            
            settingsModal.style.display = 'block';
        }

        function closeSettings() {
            settingsModal.style.display = 'none';
        }

        async function saveSettings() {
            const newEmail = document.getElementById('settingsEmail').value.trim();
            const newContact = document.getElementById('settingsContact').value.trim();
            const newDepartment = document.getElementById('settingsDepartment').value;
            const newPassword = document.getElementById('settingsPassword').value;

            if (!newEmail || !newContact || !newDepartment) {
                showAlert('settingsAlert', 'Please fill in all required fields.');
                return;
            }

            try {
                // Update Firestore
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    email: newEmail,
                    contact: newContact,
                    department: newDepartment
                });

                // Update email if changed
                if (newEmail !== currentUserData.email) {
                    await updateEmail(currentUser, newEmail);
                }

                // Update password if provided
                if (newPassword && newPassword.length >= 6) {
                    await updatePassword(currentUser, newPassword);
                }

                currentUserData.email = newEmail;
                currentUserData.contact = newContact;
                currentUserData.department = newDepartment;

                showAlert('settingsAlert', 'Settings updated successfully!', 'success');
                
                setTimeout(() => {
                    closeSettings();
                    loadUserDashboard();
                }, 2000);

            } catch (error) {
                console.error('Error updating settings:', error);
                showAlert('settingsAlert', 'Failed to update settings. Please try again.');
            }
        }

        // Search Function
        function setupSearch() {
            const searchBar = document.getElementById('adminSearchBar');
            if (searchBar) {
                searchBar.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('.appointment-row');
                    
                    rows.forEach(row => {
                        const searchData = row.getAttribute('data-search').toLowerCase();
                        if (searchData.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auth state observer
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showDashboard();
                } else {
                    currentUser = null;
                    currentUserData = null;
                    showLoginPage();
                }
            });

            // Login/Register Navigation
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                showRegisterPage();
            });

            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginPage();
            });

            // Authentication
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            document.getElementById('googleSignInBtn').addEventListener('click', googleSignIn);
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);

            // Dashboard Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // Show corresponding section
                    const section = item.getAttribute('data-section');
                    document.querySelectorAll('#dashboard > div:not(.user-info):not(.nav-menu)').forEach(div => {
                        div.classList.add('hidden');
                    });

                    if (section === 'appointments') {
                        document.getElementById('appointmentsSection').classList.remove('hidden');
                    } else if (section === 'bookAppointment') {
                        document.getElementById('bookAppointmentSection').classList.remove('hidden');
                    } else if (section === 'healthRecords') {
                        document.getElementById('healthRecordsSection').classList.remove('hidden');
                    } else if (section === 'adminPanel') {
                        document.getElementById('adminPanelSection').classList.remove('hidden');
                        loadAllAppointments();
                        setupSearch();
                    }
                });
            });

            // Admin Navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Update active state
                    document.querySelectorAll('.admin-nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // Show corresponding admin section
                    const section = item.getAttribute('data-section');
                    if (section === 'allAppointments') {
                        document.getElementById('allAppointmentsView').classList.remove('hidden');
                        document.getElementById('addRecordView').classList.add('hidden');
                        loadAllAppointments();
                        setupSearch();
                    } else if (section === 'addRecord') {
                        document.getElementById('addRecordView').classList.remove('hidden');
                        document.getElementById('allAppointmentsView').classList.add('hidden');
                    }
                });
            });

            // Appointments
            document.getElementById('bookAppointmentBtn').addEventListener('click', bookAppointment);

            // Health Records
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);

            // Admin Functions
            document.getElementById('addRecordBtn').addEventListener('click', addHealthRecord);

            // Settings
            document.getElementById('showSettingsBtn').addEventListener('click', showSettings);
            document.getElementById('closeSettings').addEventListener('click', closeSettings);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

            // Modal close when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    closeSettings();
                }
            });

            // Enter key listeners
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (!loginPage.classList.contains('hidden')) {
                        loginUser();
                    } else if (!registerPage.classList.contains('hidden')) {
                        registerUser();
                    }
                }
            });
        });
    </script>
</body>

</html>
